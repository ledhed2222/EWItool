name: Build Native Installers

on:
  push:
    tags:
      - 'v*'         # Only builds on version tags like v2.4.3
  workflow_dispatch: # Manual trigger from the GitHub UI

jobs:
  mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build .jar
        run: mvn clean package

      - name: Run jpackage for macOS
        run: |
          jpackage \
            --type dmg \
            --name EWItool \
            --input target \
            --main-jar EWItool-2.4.3.jar \
            --main-class com.github.ledhed2222.ewitool.Main \
            --dest target \
            --app-version 2.4.3 \
            --vendor "Ledhed2222"

      - name: Upload to gh release
        uses: softprops/action-gh-release@v1
        with:
          files: target/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build .jar
        run: mvn clean package

      - name: Run jpackage for Windows
        run: |
          jpackage ^
            --type exe ^
            --name EWItool ^
            --input target ^
            --main-jar EWItool-2.4.3.jar ^
            --main-class com.github.ledhed2222.ewitool.Main ^
            --dest target ^
            --app-version 2.4.3 ^
            --vendor "Ledhed2222"

      - name: Upload to gh release
        uses: softprops/action-gh-release@v1
        with:
          files: target/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install jpackage dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfreetype6-dev libasound2-dev fakeroot rpm

      - name: Build .jar
        run: mvn clean package

      - name: Run jpackage for Linux
        run: |
          jpackage \
            --type deb \
            --name EWItool \
            --input target \
            --main-jar EWItool-2.4.3.jar \
            --main-class com.github.ledhed2222.ewitool.Main \
            --dest target \
            --app-version 2.4.3 \
            --vendor "Ledhed2222"

      - name: Upload to gh release
        uses: softprops/action-gh-release@v1
        with:
          files: target/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
